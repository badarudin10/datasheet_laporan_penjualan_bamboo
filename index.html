<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooArt Enterprise Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0b0f0c; color: #e2e8f0; background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); }
        .glass { background: rgba(15, 23, 18, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; overflow-y: auto; }
        .card-stats { border-radius: 2rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-stats:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        th { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 1rem; }
        td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        @media print { .no-print { display: none !important; } .modal { display: block !important; position: static; background: white; color: black; } }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-10 no-print">
            <div>
                <h1 class="text-3xl font-black text-green-500 italic tracking-tighter">BAMBOOART <span class="text-white">ERP</span></h1>
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em]">Master Database Control</p>
            </div>
            <div class="flex gap-3">
                <button onclick="location.reload()" class="glass px-4 py-2 rounded-xl text-xs font-bold">üîÑ REFRESH</button>
                <button onclick="window.print()" class="bg-white text-black px-4 py-2 rounded-xl text-xs font-black">üìÑ PRINT REPORT</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-stats bg-green-600 p-8 shadow-2xl overflow-hidden relative">
                <p class="text-xs font-bold uppercase opacity-80 mb-2">Omzet Tahunan (Total)</p>
                <h2 id="mainOmzet" class="text-4xl font-black">Rp 0</h2>
                <div class="absolute -right-2 -bottom-2 opacity-10 text-6xl font-black italic">OMZET</div>
            </div>
            <div class="card-stats bg-amber-500 p-8 shadow-2xl overflow-hidden relative text-black">
                <p class="text-xs font-bold uppercase opacity-80 mb-2">Modal Mati (Aset Macet)</p>
                <h2 id="mainCapital" class="text-4xl font-black">Rp 0</h2>
                <div class="absolute -right-2 -bottom-2 opacity-10 text-6xl font-black italic">MODAL</div>
            </div>
            <div class="card-stats bg-sky-600 p-8 shadow-2xl overflow-hidden relative">
                <p class="text-xs font-bold uppercase opacity-80 mb-2">Estimasi Keuntungan</p>
                <h2 id="mainProfit" class="text-4xl font-black">Rp 0</h2>
                <div class="absolute -right-2 -bottom-2 opacity-10 text-6xl font-black italic">PROFIT</div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 no-print">
            <button onclick="openModal('modDetailSales')" class="glass p-6 rounded-3xl text-center hover:bg-white/10 transition group">
                <span class="block text-2xl mb-2 group-hover:scale-125 transition">üìÖ</span>
                <span class="text-[10px] font-black uppercase">Laporan Bulanan</span>
            </button>
            <button onclick="openModal('modMarket')" class="glass p-6 rounded-3xl text-center hover:bg-white/10 transition group">
                <span class="block text-2xl mb-2 group-hover:scale-125 transition">üîç</span>
                <span class="text-[10px] font-black uppercase">Analisa Pasar</span>
            </button>
            <button onclick="openModal('modInventory')" class="glass p-6 rounded-3xl text-center hover:bg-white/10 transition group">
                <span class="block text-2xl mb-2 group-hover:scale-125 transition">üì¶</span>
                <span class="text-[10px] font-black uppercase">Stok & Modal</span>
            </button>
            <a href="https://docs.google.com/spreadsheets/d/14ZCE5Vh3yCfBwJqztin6lwNRFfviPGFh7ThLQQMHTi4/edit" target="_blank" class="glass p-6 rounded-3xl text-center hover:bg-green-600 transition group border-green-500/50">
                <span class="block text-2xl mb-2 group-hover:scale-125 transition">üìù</span>
                <span class="text-[10px] font-black uppercase">Edit Database</span>
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="glass p-8 rounded-[2.5rem]">
                <h3 class="text-xs font-black uppercase text-green-500 mb-6 tracking-widest italic">Performa Penjualan 2026</h3>
                <div class="h-64"><canvas id="lineChart"></canvas></div>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="glass rounded-[2.5rem] overflow-hidden relative group">
                    <img src="kapal.jpg" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition" onerror="this.src='https://images.unsplash.com/photo-1594818379496-da1e345b0ded?q=80&w=500&auto=format&fit=crop'">
                    <div class="absolute bottom-6 left-6 font-black uppercase italic text-xl">Koleksi Kapal</div>
                </div>
                <div class="glass rounded-[2.5rem] overflow-hidden relative group">
                    <img src="rumah.jpg" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition" onerror="this.src='https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?q=80&w=500&auto=format&fit=crop'">
                    <div class="absolute bottom-6 left-6 font-black uppercase italic text-xl">Miniatur Rumah</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modDetailSales" class="modal">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-3xl font-black text-white italic">STRUK LAPORAN BULANAN</h2>
                <button onclick="closeModal('modDetailSales')" class="text-4xl text-gray-500 hover:text-white">&times;</button>
            </div>
            <div id="monthlyDetailedList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </div>
    </div>

    <div id="modMarket" class="modal">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
                <h2 class="text-3xl font-black text-sky-500 italic uppercase">Bedah Pasar BambooArt</h2>
                <button onclick="closeModal('modMarket')" class="text-4xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="bg-red-600 text-white p-4 rounded-t-3xl font-black text-center text-xs uppercase italic">üö® Stock Limit (Wajib Produksi)</h3>
                    <div class="glass rounded-b-3xl p-4 overflow-hidden">
                        <table class="w-full text-xs">
                            <tbody id="marketCriticalBody"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 class="bg-amber-500 text-black p-4 rounded-t-3xl font-black text-center text-xs uppercase italic">üê¢ Slow Moving (Butuh Diskon)</h3>
                    <div class="glass rounded-b-3xl p-4 overflow-hidden">
                        <table class="w-full text-xs">
                            <tbody id="marketSlowBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modInventory" class="modal">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-black text-green-500 italic uppercase">Manajemen Aset & Modal</h2>
                <button onclick="closeModal('modInventory')" class="text-4xl">&times;</button>
            </div>
            <div class="glass rounded-[2rem] overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-white/5">
                        <tr>
                            <th>Nama Produk</th>
                            <th class="text-center">Stok</th>
                            <th class="text-center">Harga Beli (Q)</th>
                            <th class="text-right">Total Aset Modal</th>
                        </tr>
                    </thead>
                    <tbody id="fullInventoryBody" class="text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXdrHU-IFBl2jmf3Unzy8Jb2Uh7VfK5uvX0OeO7Ivlc88QC6ahXNFJf1VlGWlTb7Mfp4xzeSY6BsXx/pub?output=csv";

        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Fungsi pembersih angka (Penting!)
        function cleanNum(val) {
            if (!val) return 0;
            return parseInt(val.toString().replace(/[^\d]/g, '')) || 0;
        }

        function syncData() {
            Papa.parse(sheetCsvUrl, {
                download: true,
                complete: function(results) {
                    const data = results.data;
                    const totalRow = data.find(r => r[2] && r[2].toString().toUpperCase().trim() === "TOTAL");
                    
                    const monthlyList = document.getElementById('monthlyDetailedList');
                    const criticalBody = document.getElementById('marketCriticalBody');
                    const slowBody = document.getElementById('marketSlowBody');
                    const inventoryBody = document.getElementById('fullInventoryBody');

                    monthlyList.innerHTML = ''; criticalBody.innerHTML = ''; slowBody.innerHTML = ''; inventoryBody.innerHTML = '';

                    let totalModalMengendap = 0;
                    let totalProfit = 0;
                    const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

                    // 1. ANALISA PER PRODUK (DETEKSI SEMUA)
                    data.forEach((row, i) => {
                        if (i > 2 && row[2] && !row[2].toUpperCase().includes("TOTAL") && row[2].trim() !== "" && row[2] !== "NAMA PRODUK") {
                            const nama = row[2];
                            const terjual = cleanNum(row[18]);
                            const stok = cleanNum(row[17]);
                            const hargaModal = cleanNum(row[16]); // Kolom Q
                            const totalAsetModal = stok * hargaModal;

                            totalProfit += (terjual * (cleanNum(row[19]) - hargaModal)); // Estimasi dari kolom Harga Jual jika ada

                            // Tabel Stok & Modal
                            inventoryBody.innerHTML += `
                                <tr>
                                    <td class="font-bold uppercase text-white">${nama}</td>
                                    <td class="text-center">${stok} Unit</td>
                                    <td class="text-center">Rp ${hargaModal.toLocaleString()}</td>
                                    <td class="text-right font-black text-amber-500">Rp ${totalAsetModal.toLocaleString()}</td>
                                </tr>`;

                            // Analisa Pasar (Kritis)
                            if (stok < 10) {
                                criticalBody.innerHTML += `<tr><td class="p-4 uppercase font-black text-red-500">${nama}</td><td class="text-right">SISA ${stok}</td></tr>`;
                            }
                            
                            // Analisa Pasar (Slow Moving)
                            if (terjual < 5) {
                                totalModalMengendap += totalAsetModal;
                                slowBody.innerHTML += `<tr><td class="p-4 uppercase font-bold">${nama}</td><td class="text-right text-amber-500">Modal Macet: Rp ${totalAsetModal.toLocaleString()}</td></tr>`;
                            }
                        }
                    });

                    // 2. LAPORAN BULANAN HIPIERAKTIF
                    if (totalRow) {
                        const chartVals = [];
                        months.forEach((mName, idx) => {
                            const colIdx = idx + 4;
                            const omzetBulanIni = totalRow[colIdx] || "0";
                            chartVals.push(cleanNum(omzetBulanIni));

                            // Cari rincian produk yang laku di bulan ini (Membaca kolom E-P)
                            let rincianProduk = '';
                            data.forEach((rowProd, px) => {
                                if (px > 2 && px < data.indexOf(totalRow)) {
                                    const qtyLaku = cleanNum(rowProd[colIdx]);
                                    if (qtyLaku > 0) {
                                        rincianProduk += `<div class="flex justify-between text-[10px] py-1 border-b border-white/5 italic"><span>${rowProd[2]}</span><span>${qtyLaku} Unit</span></div>`;
                                    }
                                }
                            });

                            monthlyList.innerHTML += `
                                <div class="glass p-6 rounded-3xl border-t-4 border-purple-500">
                                    <h4 class="font-black text-purple-400 uppercase text-xs mb-3">${mName}</h4>
                                    <div class="mb-4">${rincianProduk || '<p class="text-[9px] text-gray-600 italic">Tidak ada penjualan</p>'}</div>
                                    <div class="flex justify-between font-black text-sm border-t border-purple-500 pt-2">
                                        <span>TOTAL OMZET</span>
                                        <span>Rp ${omzetBulanIni}</span>
                                    </div>
                                </div>`;
                        });
                        renderChart(chartVals);
                        document.getElementById('mainOmzet').innerText = "Rp " + (totalRow[20] || "0");
                        document.getElementById('mainProfit').innerText = "Rp " + (cleanNum(totalRow[20]) * 0.4).toLocaleString(); // Asumsi margin 40% jika kolom untung tidak ada
                    }

                    document.getElementById('mainCapital').innerText = "Rp " + totalModalMengendap.toLocaleString();
                }
            });
        }

        let myChart;
        function renderChart(vals) {
            const ctx = document.getElementById('lineChart');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['J','F','M','A','M','J','J','A','S','O','N','D'],
                    datasets: [{ label: 'Omzet', data: vals, backgroundColor: '#22c55e', borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { ticks: { color: '#475569' }, grid: { display: false } } } }
            });
        }
        syncData();
    </script>
</body>
</html>

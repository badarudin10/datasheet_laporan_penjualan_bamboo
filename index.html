<script>
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXdrHU-IFBl2jmf3Unzy8Jb2Uh7VfK5uvX0OeO7Ivlc88QC6ahXNFJf1VlGWlTb7Mfp4xzeSY6BsXx/pub?output=csv";

        function syncData() {
            Papa.parse(sheetUrl, {
                download: true,
                complete: function(results) {
                    const data = results.data;
                    
                    // 1. CARI BARIS TOTAL
                    const totalRow = data.find(r => r.join('').toUpperCase().includes("TOTAL"));
                    
                    if (totalRow) {
                        // DETEKSI OTOMATIS KOLOM
                        // Kita ambil angka terjual (biasanya kolom 18 atau 19)
                        const unitTerjual = totalRow[18] || "0";
                        const stokTersisa = totalRow[19] || "0";
                        
                        // Omzet biasanya angka paling besar di baris total
                        // Kita cari angka yang mengandung nilai jutaan atau ribuan
                        let omzetVal = totalRow[20] || "0"; 

                        document.getElementById('displaySold').innerText = unitTerjual;
                        document.getElementById('displayStock').innerText = stokTersisa;
                        document.getElementById('displayRev').innerText = "Rp " + omzetVal;

                        // DATA GRAFIK (Jan - Des)
                        // Mengambil kolom E sampai P (index 4 sampai 15)
                        const monthlyData = [];
                        for (let i = 4; i <= 15; i++) {
                            let val = totalRow[i] ? totalRow[i].toString().replace(/\D/g, '') : "0";
                            monthlyData.push(parseInt(val) || 0);
                        }
                        
                        renderChart(monthlyData);
                    }

                    // 2. ISI TABEL INVENTORY
                    const tbody = document.getElementById('inventoryBody');
                    tbody.innerHTML = '';
                    data.forEach((row, i) => {
                        // Lewati header, ambil yang ada nama produk di kolom C (index 2)
                        if (i > 2 && row[2] && !row[2].toUpperCase().includes("TOTAL") && row[2].trim() !== "") {
                            const s = parseInt(row[19]) || 0;
                            const t = row[18] || "0";
                            
                            tbody.innerHTML += `
                                <tr class="hover:bg-white/5 transition border-b border-white/5">
                                    <td class="p-4 font-bold text-gray-200">${row[2]}</td>
                                    <td class="p-4 text-center font-mono text-blue-300 font-bold">${t}</td>
                                    <td class="p-4 text-center font-mono text-gray-300">${s}</td>
                                    <td class="p-4 text-right">
                                        <span class="px-2 py-1 rounded text-[9px] font-bold ${s < 10 ? 'bg-red-500/20 text-red-500 border border-red-500/50' : 'bg-green-500/20 text-green-400 border border-green-500/50'}">
                                            ${s < 10 ? 'KRITIS' : 'AMAN'}
                                        </span>
                                    </td>
                                </tr>`;
                        }
                    });
                }
            });
        }

        let myChart;
        function renderChart(monthlyValues) {
            const ctx = document.getElementById('lineChart');
            if (myChart) myChart.destroy(); // Hapus grafik lama sebelum gambar baru
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
                    datasets: [{
                        label: 'Unit Terjual',
                        data: monthlyValues,
                        borderColor: '#ffffff',
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: '#5cb85c'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        // Jalankan Sinkronisasi
        syncData();
        // Update setiap 5 menit
        setInterval(syncData, 300000);
    </script>
</body>
</html>

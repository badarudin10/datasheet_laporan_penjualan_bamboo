<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooArt Business Auditor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0b0f0c; color: white; background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png'); }
        .glass { background: rgba(15, 23, 18, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; padding: 15px; overflow-y: auto; }
        .card-dash { border-radius: 2rem; border-bottom: 6px solid rgba(0,0,0,0.3); }
        @media print { .no-print { display: none !important; } .modal { display: block !important; position: static; background: white; color: black; } }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 no-print">
            <h1 class="text-2xl font-black text-green-500 italic">BAMBOOART AUDITOR</h1>
            <div class="flex gap-2">
                <button onclick="location.reload()" class="bg-white/10 p-3 rounded-xl text-[10px] font-bold">üîÑ REFRESH</button>
                <button onclick="window.print()" class="bg-green-600 p-3 rounded-xl text-[10px] font-bold">üìÑ PRINT</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="card-dash bg-green-700 p-8 shadow-2xl relative overflow-hidden">
                <p class="text-[10px] font-black uppercase opacity-70 mb-1">Total Omzet (Tahun Berjalan)</p>
                <h2 id="displayOmzet" class="text-4xl font-black italic">Rp 0</h2>
                <div class="absolute -right-4 -bottom-4 opacity-10 text-6xl font-black italic">CASH</div>
            </div>
            <div class="card-dash bg-amber-500 p-8 shadow-2xl relative overflow-hidden text-black">
                <p class="text-[10px] font-black uppercase opacity-70 mb-1 italic text-red-800">‚ö†Ô∏è Total Modal Mengendap (Slow Moving)</p>
                <h2 id="displayModalMati" class="text-4xl font-black italic">Rp 0</h2>
                <p class="text-[9px] font-bold mt-2 uppercase underline cursor-pointer" onclick="openModal('modMarket')">Lihat Rincian Produk & Harga ></p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-10 no-print">
            <button onclick="openModal('modMarket')" class="glass p-6 rounded-[2rem] text-center border-amber-500/50 hover:bg-amber-500/10">
                <span class="block text-2xl mb-1">üê¢</span>
                <span class="text-[10px] font-black uppercase text-amber-500 italic">Analisa Slow Moving</span>
            </button>
            <button onclick="openModal('modDetailSales')" class="glass p-6 rounded-[2rem] text-center border-purple-500/50 hover:bg-purple-500/10">
                <span class="block text-2xl mb-1">üìÖ</span>
                <span class="text-[10px] font-black uppercase text-purple-400 italic">Laporan Bulanan</span>
            </button>
            <a href="https://docs.google.com/spreadsheets/d/14ZCE5Vh3yCfBwJqztin6lwNRFfviPGFh7ThLQQMHTi4/edit" target="_blank" class="glass p-6 rounded-[2rem] text-center border-white/50 hover:bg-white/10">
                <span class="block text-2xl mb-1">üìù</span>
                <span class="text-[10px] font-black uppercase italic">Input Data (Sheet)</span>
            </a>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-10 no-print">
            <div class="glass rounded-[2rem] overflow-hidden relative h-48">
                <img src="kapal.jpg" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1594818379496-da1e345b0ded?q=80&w=500&auto=format&fit=crop'">
                <div class="absolute bottom-4 left-4 font-black italic text-lg uppercase shadow-lg">Koleksi Kapal</div>
            </div>
            <div class="glass rounded-[2rem] overflow-hidden relative h-48">
                <img src="rumah.jpg" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?q=80&w=500&auto=format&fit=crop'">
                <div class="absolute bottom-4 left-4 font-black italic text-lg uppercase shadow-lg">Miniatur Rumah</div>
            </div>
        </div>
    </div>

    <div id="modMarket" class="modal">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8 border-b border-amber-500 pb-4">
                <h2 class="text-3xl font-black text-amber-500 italic">RINCIAN MODAL MENGENDAP</h2>
                <button onclick="closeModal('modMarket')" class="text-4xl">&times;</button>
            </div>
            
            <div class="glass rounded-[2rem] overflow-hidden mb-6">
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-amber-600 text-black font-black uppercase">
                        <tr>
                            <th class="p-4">Nama Produk</th>
                            <th class="p-4 text-center">Harga Modal (Q)</th>
                            <th class="p-4 text-center">Sisa Stok</th>
                            <th class="p-4 text-right">Total Modal Macet</th>
                        </tr>
                    </thead>
                    <tbody id="slowMovingBody" class="divide-y divide-white/5"></tbody>
                    <tfoot class="bg-white/10 font-black">
                        <tr>
                            <td colspan="3" class="p-4 text-right text-amber-500 uppercase">TOTAL KESELURUHAN MODAL MATI:</td>
                            <td id="totalMatiDiTabel" class="p-4 text-right text-2xl text-amber-500">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <p class="text-[10px] text-gray-400 italic italic">*Produk di atas adalah produk dengan penjualan kurang dari 5 unit. Segera adakan promo besar-besaran untuk mengembalikan modal.</p>
        </div>
    </div>

    <div id="modDetailSales" class="modal">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-black text-purple-500 italic">STRUK OMZET BULANAN</h2>
                <button onclick="closeModal('modDetailSales')" class="text-4xl">&times;</button>
            </div>
            <div id="monthlyList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script>
        const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXdrHU-IFBl2jmf3Unzy8Jb2Uh7VfK5uvX0OeO7Ivlc88QC6ahXNFJf1VlGWlTb7Mfp4xzeSY6BsXx/pub?output=csv";

        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Fungsi pembersih angka yang lebih kuat
        function cleanNum(val) {
            if (!val || val === "") return 0;
            // Menghilangkan Rp, titik, koma, dan spasi
            let clean = val.toString().replace(/Rp/g, '').replace(/\./g, '').replace(/,/g, '').trim();
            return parseInt(clean) || 0;
        }

        function syncData() {
            Papa.parse(sheetCsvUrl, {
                download: true,
                complete: function(results) {
                    const data = results.data;
                    const slowBody = document.getElementById('slowMovingBody');
                    const monthlyList = document.getElementById('monthlyList');
                    let grandTotalModalMati = 0;

                    slowBody.innerHTML = '';
                    monthlyList.innerHTML = '';

                    // 1. CARI BARIS TOTAL UNTUK OMZET UTAMA
                    const totalRow = data.find(r => r[2] && r[2].toString().toUpperCase().trim() === "TOTAL");
                    if (totalRow) {
                        document.getElementById('displayOmzet').innerText = "Rp " + totalRow[20];
                    }

                    // 2. PROSES TIAP BARIS PRODUK
                    data.forEach((row, i) => {
                        // Lewati header dan baris total
                        if (i > 2 && row[2] && !row[2].toUpperCase().includes("TOTAL") && row[2].trim() !== "" && row[2] !== "NAMA PRODUK") {
                            
                            const nama = row[2];
                            const terjual = cleanNum(row[18]);
                            const stok = cleanNum(row[17]);
                            const hargaModal = cleanNum(row[16]); // Kolom Q
                            const totalAsetProduk = stok * hargaModal;

                            // ANALISA SLOW MOVING (LAKU < 5)
                            if (terjual < 5) {
                                grandTotalModalMati += totalAsetProduk;
                                
                                slowBody.innerHTML += `
                                    <tr>
                                        <td class="p-4 font-black uppercase text-white">${nama}</td>
                                        <td class="p-4 text-center text-gray-400">Rp ${hargaModal.toLocaleString()}</td>
                                        <td class="p-4 text-center text-white font-bold">${stok} Unit</td>
                                        <td class="p-4 text-right font-black text-amber-500">Rp ${totalAsetProduk.toLocaleString()}</td>
                                    </tr>`;
                            }
                        }
                    });

                    // 3. TAMPILKAN TOTAL KE KOTAK KUNING & TABEL
                    document.getElementById('displayModalMati').innerText = "Rp " + grandTotalModalMati.toLocaleString();
                    document.getElementById('totalMatiDiTabel').innerText = "Rp " + grandTotalModalMati.toLocaleString();

                    // 4. LAPORAN BULANAN DETAIL
                    if (totalRow) {
                        const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
                        months.forEach((mName, idx) => {
                            const colIdx = idx + 4; // Kolom E s/d P
                            const omzetBulan = totalRow[colIdx] || "0";
                            
                            let rincianBulan = "";
                            data.forEach((rowP, idxP) => {
                                if (idxP > 2 && idxP < data.indexOf(totalRow)) {
                                    const qty = cleanNum(rowP[colIdx]);
                                    if (qty > 0) {
                                        rincianBulan += `<div class="flex justify-between py-1 border-b border-white/5 text-[10px]"><span>${rowP[2]}</span><span class="font-bold">${qty} Unit</span></div>`;
                                    }
                                }
                            });

                            monthlyList.innerHTML += `
                                <div class="glass p-5 rounded-3xl border-l-4 border-purple-500">
                                    <h4 class="font-black text-purple-400 text-xs uppercase mb-3">${mName}</h4>
                                    <div class="mb-4">${rincianBulan || '<p class="text-[9px] text-gray-600">Tidak ada penjualan</p>'}</div>
                                    <div class="flex justify-between font-black text-xs pt-2 border-t border-purple-900">
                                        <span>TOTAL</span>
                                        <span>Rp ${omzetBulan}</span>
                                    </div>
                                </div>`;
                        });
                    }
                }
            });
        }

        syncData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooArt Professional ERP System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #050505; color: #fff; }
        .stat-card { background: linear-gradient(145deg, #111, #000); border: 1px solid #333; transition: 0.3s; }
        .stat-card:hover { border-color: #10b981; transform: translateY(-5px); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99; backdrop-filter: blur(10px); }
        .btn-action { background: #10b981; color: #000; font-weight: 900; text-transform: uppercase; padding: 12px; border-radius: 8px; font-size: 11px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-6xl mx-auto mb-10 no-print">
        <div class="stat-card p-4 rounded-xl flex flex-wrap gap-4 items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">System Connected to Live Sheets</span>
            </div>
            <div class="flex gap-2 flex-1 max-w-lg">
                <input type="text" id="sheetUrl" placeholder="Masukkan Link CSV/Spreadsheet Anda..." class="bg-black border border-gray-800 rounded-lg p-2 text-xs w-full outline-none focus:border-green-500 text-gray-400" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQXdrHU-IFBl2jmf3Unzy8Jb2Uh7VfK5uvX0OeO7Ivlc88QC6ahXNFJf1VlGWlTb7Mfp4xzeSY6BsXx/pub?output=csv">
                <button onclick="initSystem()" class="bg-white text-black font-black text-[10px] px-4 rounded-lg uppercase">Update</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="stat-card p-8 rounded-3xl md:col-span-2 border-b-4 border-b-green-500">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-2 italic">Total Omzet Pertahun (Live Data)</p>
                <h1 id="totalOmzet" class="text-5xl font-black text-white tracking-tighter">Rp 0</h1>
            </div>
            <div class="stat-card p-8 rounded-3xl border-b-4 border-b-amber-500 cursor-pointer" onclick="showModal('financeModal')">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-2 italic">Modal Macet (Sisa Stok)</p>
                <h1 id="totalModal" class="text-3xl font-black text-amber-500 tracking-tighter">Rp 0</h1>
            </div>
            <div class="stat-card p-8 rounded-3xl border-b-4 border-b-sky-500">
                <p class="text-[10px] font-black text-gray-500 uppercase mb-2 italic">Estimasi Keuntungan Bersih</p>
                <h1 id="totalProfit" class="text-3xl font-black text-sky-400 tracking-tighter">Rp 0</h1>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="stat-card p-6 rounded-3xl md:col-span-2 h-[400px]">
                <canvas id="salesChart"></canvas>
            </div>
            <div class="flex flex-col gap-4 no-print">
                <button onclick="showModal('marketModal')" class="stat-card p-6 rounded-2xl text-left hover:bg-gray-900">
                    <h3 class="font-black text-xs uppercase text-green-500">ðŸ“Š Analisa Performa Produk</h3>
                    <p class="text-[10px] text-gray-500 mt-1">Cek barang paling laku & slow moving</p>
                </button>
                <button onclick="showModal('financeModal')" class="stat-card p-6 rounded-2xl text-left hover:bg-gray-900">
                    <h3 class="font-black text-xs uppercase text-amber-500">ðŸ’° Laporan Modal Mengendap</h3>
                    <p class="text-[10px] text-gray-500 mt-1">Saran diskon untuk barang stok lama</p>
                </button>
                <div class="stat-card p-6 rounded-2xl bg-gradient-to-br from-gray-900 to-black">
                    <h3 class="font-black text-[10px] text-gray-400 uppercase italic mb-4">Maintenance Status</h3>
                    <div class="flex justify-between text-[10px] mb-2"><span>Data Accuracy:</span> <span class="text-green-500 font-bold">100% Verified</span></div>
                    <div class="flex justify-between text-[10px]"><span>Last Sync:</span> <span id="syncTime">--:--</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="financeModal" class="modal p-6 overflow-y-auto">
        <div class="max-w-5xl mx-auto bg-black border border-gray-800 p-8 rounded-3xl">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-black italic uppercase">Financial & Inventory Audit</h2>
                <button onclick="closeModal('financeModal')" class="text-2xl text-red-500 font-black">CLOSE</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card p-4 rounded-xl border-l-4 border-red-500">
                    <p class="text-[10px] font-bold text-gray-500 uppercase">Potensi Rugi (Barang Macet)</p>
                    <h4 id="deadCapital" class="text-xl font-black">Rp 0</h4>
                </div>
            </div>
            <table class="w-full text-xs text-left">
                <thead class="bg-gray-900 uppercase font-black">
                    <tr><th class="p-4">Produk</th><th class="p-4">Hrg Modal (C)</th><th class="p-4">Terjual (Q)</th><th class="p-4">Stok (R)</th><th class="p-4 text-right">Aset Macet</th><th class="p-4">Tindakan</th></tr>
                </thead>
                <tbody id="financeTableBody" class="divide-y divide-gray-800"></tbody>
            </table>
        </div>
    </div>

    <div id="marketModal" class="modal p-6 overflow-y-auto">
        <div class="max-w-4xl mx-auto bg-black border border-gray-800 p-8 rounded-3xl">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-black italic uppercase">Market Intelligence</h2>
                <button onclick="closeModal('marketModal')" class="text-2xl text-red-500 font-black">CLOSE</button>
            </div>
            <div id="marketList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script>
        let myChart;

        function showModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function initSystem() {
            const url = document.getElementById('sheetUrl').value;
            Papa.parse(url, {
                download: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function processData(data) {
            const fBody = document.getElementById('financeTableBody');
            const mList = document.getElementById('marketList');
            let totalRevenue = 0;
            let totalModalMacet = 0;
            let totalCogsSold = 0;

            fBody.innerHTML = ''; mList.innerHTML = '';
            
            // Mencari Baris OMZET (Mendeteksi Kata 'OMZET' di Kolom B)
            const omzetRow = data.find(r => r[1] && r[1].toString().toUpperCase().trim() === "OMZET");
            
            if (omzetRow) {
                totalRevenue = parseInt((omzetRow[15] || "0").replace(/[^\d]/g, '')) || 0;
                document.getElementById('totalOmzet').innerText = "Rp " + totalRevenue.toLocaleString();
                
                // Grafik Omzet (Kolom D - O)
                const monthlyData = [];
                for(let i=3; i<=14; i++) {
                    monthlyData.push(parseInt((omzetRow[i] || "0").replace(/[^\d]/g, '')) || 0);
                }
                updateChart(monthlyData);
            }

            // Memproses Data Produk (Mulai Baris 4 ke bawah)
            data.forEach((row, i) => {
                if (i >= 3 && row[1] && row[1].trim() !== "" && row[1].toUpperCase() !== "OMZET") {
                    const nama = row[1]; // B
                    const hModal = parseInt((row[2] || "0").replace(/[^\d]/g, '')) || 0; // C
                    const laku = parseInt(row[16]) || 0; // Q
                    const stok = parseInt(row[17]) || 0; // R
                    const subAsset = stok * hModal;

                    totalModalMacet += subAsset;
                    totalCogsSold += (laku * hModal);

                    // Isi Tabel Audit
                    fBody.innerHTML += `
                        <tr class="hover:bg-gray-900 transition">
                            <td class="p-4 font-bold text-white uppercase">${nama}</td>
                            <td class="p-4 text-gray-500">Rp ${hModal.toLocaleString()}</td>
                            <td class="p-4 text-center font-bold text-green-500">${laku}</td>
                            <td class="p-4 text-center font-bold text-amber-500">${stok}</td>
                            <td class="p-4 text-right font-black">Rp ${subAsset.toLocaleString()}</td>
                            <td class="p-4 uppercase">
                                <span class="bg-red-500/10 text-red-500 px-2 py-1 rounded text-[9px] font-black">
                                    ${laku < 5 ? 'DISCOUNT 50%' : 'STABIL'}
                                </span>
                            </td>
                        </tr>
                    `;

                    // Isi Market Intelligence
                    if (stok < 10 || laku < 5) {
                        mList.innerHTML += `
                            <div class="stat-card p-5 rounded-2xl border-l-4 ${stok < 10 ? 'border-red-500' : 'border-amber-500'}">
                                <h4 class="font-black uppercase text-xs mb-2">${nama}</h4>
                                <p class="text-[10px] text-gray-400">Status: ${stok < 10 ? 'CRITICAL STOCK' : 'SLOW MOVING'}</p>
                                <div class="mt-4 text-[10px] font-black uppercase text-center p-2 bg-white/5 rounded italic">
                                    ${stok < 10 ? 'ðŸš¨ Segera Produksi Ulang!' : 'ðŸ“‰ Segera Lakukan Obral Besar!'}
                                </div>
                            </div>
                        `;
                    }
                }
            });

            document.getElementById('totalModal').innerText = "Rp " + totalModalMacet.toLocaleString();
            document.getElementById('deadCapital').innerText = "Rp " + totalModalMacet.toLocaleString();
            document.getElementById('totalProfit').innerText = "Rp " + (totalRevenue - totalCogsSold).toLocaleString();
            document.getElementById('syncTime').innerText = new Date().toLocaleTimeString();
        }

        function updateChart(vals) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
                    datasets: [{
                        label: 'Omzet Bulanan',
                        data: vals,
                        borderColor: '#10b981',
                        borderWidth: 4,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.05)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { ticks: { color: '#444', font: { size: 10, weight: 'bold' } }, grid: { display: false } }
                    }
                }
            });
        }

        initSystem();
    </script>
</body>
</html>
